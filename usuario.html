<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo de Productos - Usuario</title>
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>
  <div class="container">
    <header>
      <h1>Dulcería Elegante - Catálogo</h1>
      <div style="text-align:right;">
        <button onclick="cerrarSesion()">Cerrar Sesión</button>
      </div>
    </header>

    <section class="section-box">
      <h2>Productos Disponibles</h2>
      <div class="productos-grid" id="productosGrid">
        <!-- Los productos se cargarán dinámicamente desde localStorage -->
      </div>
    </section>

    <section class="section-box" id="carritoSection" style="display:none;">
      <h2>Carrito de Compras</h2>
      <table id="tablaCarrito">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Subtotal</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p style="text-align:right; font-weight:700; font-size:1.3em; margin-top:15px;">
        Total: $<span id="totalCompra">0</span> MXN
      </p>

      <div style="text-align:right; margin-top:20px;">
        <button onclick="realizarPedido()">Realizar Pedido</button>
      </div>
    </section>

    <footer>
      &copy; 2025 Dulcería Elegante - Todos los derechos reservados
    </footer>
  </div>

<script>
  const carrito = {};
  const productosGrid = document.getElementById('productosGrid');
  const carritoSection = document.getElementById('carritoSection');
  const tablaCarritoBody = document.querySelector('#tablaCarrito tbody');
  const totalCompraEl = document.getElementById('totalCompra');

  // Cargar productos desde localStorage
  const productos = JSON.parse(localStorage.getItem('productos')) || [];

  if (productos.length === 0) {
    productosGrid.innerHTML = "<p>No hay productos disponibles.</p>";
  } else {
    productos.forEach((producto, index) => {
      const div = document.createElement('div');
      div.classList.add('producto');
      div.dataset.id = index;
      div.dataset.nombre = producto.nombre;
      div.dataset.precio = producto.precio;

      div.innerHTML = `
        <img src="${producto.imagen}" alt="${producto.nombre}" />
        <h3>${producto.nombre}</h3>
        <p>${producto.descripcion}</p>
        <p class="price">$${producto.precio} MXN</p>
        <button class="btn-agregar">Agregar al carrito</button>
      `;

      productosGrid.appendChild(div);
    });
  }

  productosGrid.addEventListener('click', e => {
    if (e.target.classList.contains('btn-agregar')) {
      const productoDiv = e.target.closest('.producto');
      const id = productoDiv.dataset.id;
      const nombre = productoDiv.dataset.nombre;
      const precio = Number(productoDiv.dataset.precio);

      if (carrito[id]) {
        carrito[id].cantidad += 1;
      } else {
        carrito[id] = { nombre, precio, cantidad: 1 };
      }

      actualizarCarrito();
    }
  });

  function actualizarCarrito() {
    tablaCarritoBody.innerHTML = '';

    let total = 0;
    const keys = Object.keys(carrito);

    if (keys.length === 0) {
      carritoSection.style.display = 'none';
      return;
    }

    carritoSection.style.display = 'block';

    keys.forEach(id => {
      const item = carrito[id];
      const subtotal = item.precio * item.cantidad;
      total += subtotal;

      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${item.nombre}</td>
        <td>${item.cantidad}</td>
        <td>$${item.precio}</td>
        <td>$${subtotal}</td>
        <td><button class="btn-eliminar" data-id="${id}">Eliminar</button></td>
      `;

      tablaCarritoBody.appendChild(tr);
    });

    totalCompraEl.textContent = total.toFixed(2);

    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        delete carrito[id];
        actualizarCarrito();
      });
    });
  }

  function cerrarSesion() {
    if (confirm("¿Estás seguro de que quieres cerrar sesión?")) {
      window.location.href = 'index.html';
    }
  }

  function realizarPedido() {
    const keys = Object.keys(carrito);
    if (keys.length === 0) {
      alert("El carrito está vacío.");
      return;
    }

    const pedido = {
      fecha: new Date().toLocaleString(),
      productos: [],
      total: 0
    };

    keys.forEach(id => {
      const item = carrito[id];
      pedido.productos.push({ ...item });
      pedido.total += item.precio * item.cantidad;
    });

    const pedidos = JSON.parse(localStorage.getItem('pedidos') || '[]');
    pedidos.push(pedido);
    localStorage.setItem('pedidos', JSON.stringify(pedidos));

    alert("¡Pedido realizado con éxito!");

    for (let id in carrito) delete carrito[id];
    actualizarCarrito();
  }
</script>
</body>
</html>
